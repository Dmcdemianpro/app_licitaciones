// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid()) @db.NVarChar(100)
  email          String    @unique @db.NVarChar(255)
  name           String?   @db.NVarChar(255)
  hashedPassword String    @db.NVarChar(255)
  role           String?   @default("USER") @db.NVarChar(50) // USER, ADMIN, MANAGER, SUPERVISOR
  activo         Boolean   @default(true)
  telefono       String?   @db.NVarChar(50)
  departamento   String?   @db.NVarChar(100)
  cargo          String?   @db.NVarChar(100)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relaciones de autenticación
  accounts       Account[]
  sessions       Session[]

  // Relaciones de funcionalidad
  ticketsCreados          Ticket[]       @relation("TicketOwner")
  ticketsAsignados        Ticket[]       @relation("TicketAssignee")
  licitacionesResponsable Licitacion[]   @relation("LicitacionResponsable")
  licitacionesCreadas     Licitacion[]   @relation("LicitacionCreatedBy")
  licitacionesEliminadas  Licitacion[]   @relation("LicitacionDeletedBy")
  citasOrganizadas        Cita[]
  citasParticipante       CitaParticipante[] @relation("CitaUser")
  notificaciones          Notificacion[]
  documentosSubidos       Documento[]
  notas                   Nota[]
  auditoriaLogs           AuditoriaLog[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid()) @db.NVarChar(100)
  userId            String  @map("user_id") @db.NVarChar(100)
  type              String  @db.NVarChar(100)
  provider          String  @db.NVarChar(100)
  providerAccountId String  @map("provider_account_id") @db.NVarChar(255)
  refresh_token     String? @db.NVarChar(MAX)
  access_token      String? @db.NVarChar(MAX)
  expires_at        Int?
  token_type        String? @db.NVarChar(100)
  scope             String? @db.NVarChar(255)
  id_token          String? @db.NVarChar(MAX)
  session_state     String? @db.NVarChar(255)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid()) @db.NVarChar(100)
  sessionToken String   @unique @map("session_token") @db.NVarChar(255)
  userId       String   @map("user_id") @db.NVarChar(100)
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String @db.NVarChar(255)
  token      String @unique @db.NVarChar(255)
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Ticket {
  id          String   @id @default(cuid()) @db.NVarChar(100)
  folio       Int      @unique @default(autoincrement())
  title       String   @db.NVarChar(255)
  description String?  @db.NVarChar(MAX)
  type        String   @db.NVarChar(100)
  priority    String   @default("MEDIA") @db.NVarChar(50) // ALTA, MEDIA, BAJA
  status      String   @default("CREADO") @db.NVarChar(50) // CREADO, ASIGNADO, INICIADO, FINALIZADO
  assignee    String?  @db.NVarChar(255)
  assigneeId  String?  @map("assignee_id") @db.NVarChar(100)
  ownerId     String   @map("owner_id") @db.NVarChar(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner          User             @relation("TicketOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignedTo     User?            @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  documentos     Documento[]
  notas          Nota[]
  soporteTecnico SoporteTecnico[]

  @@map("tickets")
  @@index([ownerId], map: "idx_ticket_owner")
  @@index([assigneeId], map: "idx_ticket_assignee")
  @@index([status], map: "idx_ticket_status")
  @@index([priority], map: "idx_ticket_priority")
  @@index([folio], map: "idx_ticket_folio")
}

model Licitacion {
  id                String   @id @default(cuid()) @db.NVarChar(100)
  folio             Int      @unique @default(autoincrement())
  codigoExterno     String?  @unique @map("codigo_externo") @db.NVarChar(100)
  nombre            String   @db.NVarChar(500)
  descripcion       String?  @db.NVarChar(MAX)
  entidad           String   @db.NVarChar(255)
  tipo              String   @default("PUBLICA") @db.NVarChar(50) // PUBLICA, PRIVADA, INTERNACIONAL
  estado            String   @default("EN_PREPARACION") @db.NVarChar(50) // EN_PREPARACION, ACTIVA, ADJUDICADA, DESIERTA, CANCELADA
  montoEstimado     Decimal? @db.Decimal(18, 2)
  moneda            String?  @default("CLP") @db.NVarChar(10)
  unidadResponsable String?  @map("unidad_responsable") @db.NVarChar(255)
  fechaPublicacion  DateTime? @map("fecha_publicacion")
  fechaCierre       DateTime? @map("fecha_cierre")
  fechaAdjudicacion DateTime? @map("fecha_adjudicacion")
  urlExterna        String?  @map("url_externa") @db.NVarChar(500)
  responsableId     String?  @map("responsable_id") @db.NVarChar(100)
  createdById       String   @map("created_by_id") @db.NVarChar(100)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime? @map("deleted_at")
  deletedById       String?  @map("deleted_by_id") @db.NVarChar(100)
  motivoEliminacion String?  @map("motivo_eliminacion") @db.NVarChar(MAX)

  // Campos adicionales de la API de Mercado Público
  // Información básica
  codigoEstado            Int?      @map("codigo_estado")
  estadoTexto             String?   @map("estado_texto") @db.NVarChar(100)
  diasCierreLicitacion    Int?      @map("dias_cierre_licitacion")
  codigoTipo              Int?      @map("codigo_tipo")
  tipoLicitacion          String?   @map("tipo_licitacion") @db.NVarChar(10) // LE, LP, LQ, etc
  tipoConvocatoria        String?   @map("tipo_convocatoria") @db.NVarChar(10)
  etapas                  Int?
  estadoEtapas            String?   @map("estado_etapas") @db.NVarChar(10)
  tomaRazon               String?   @map("toma_razon") @db.NVarChar(10)
  estadoPublicidadOfertas Int?      @map("estado_publicidad_ofertas")
  contrato                String?   @db.NVarChar(10)
  obras                   String?   @db.NVarChar(10)
  cantidadReclamos        Int?      @map("cantidad_reclamos")

  // Información del Comprador
  codigoOrganismo     String? @map("codigo_organismo") @db.NVarChar(50)
  rutUnidad           String? @map("rut_unidad") @db.NVarChar(50)
  codigoUnidad        String? @map("codigo_unidad") @db.NVarChar(50)
  nombreUnidad        String? @map("nombre_unidad") @db.NVarChar(500)
  direccionUnidad     String? @map("direccion_unidad") @db.NVarChar(500)
  comunaUnidad        String? @map("comuna_unidad") @db.NVarChar(100)
  regionUnidad        String? @map("region_unidad") @db.NVarChar(100)
  rutUsuario          String? @map("rut_usuario") @db.NVarChar(50)
  codigoUsuario       String? @map("codigo_usuario") @db.NVarChar(50)
  nombreUsuario       String? @map("nombre_usuario") @db.NVarChar(255)
  cargoUsuario        String? @map("cargo_usuario") @db.NVarChar(255)

  // Fechas adicionales
  fechaCreacion               DateTime? @map("fecha_creacion")
  fechaInicio                 DateTime? @map("fecha_inicio")
  fechaFinal                  DateTime? @map("fecha_final")
  fechaPubRespuestas          DateTime? @map("fecha_pub_respuestas")
  fechaActoAperturaTecnica    DateTime? @map("fecha_acto_apertura_tecnica")
  fechaActoAperturaEconomica  DateTime? @map("fecha_acto_apertura_economica")
  fechaEstimadaAdjudicacion   DateTime? @map("fecha_estimada_adjudicacion")
  fechaSoporteFisico          DateTime? @map("fecha_soporte_fisico")
  fechaTiempoEvaluacion       DateTime? @map("fecha_tiempo_evaluacion")
  fechaEstimadaFirma          DateTime? @map("fecha_estimada_firma")
  fechaVisitaTerreno          DateTime? @map("fecha_visita_terreno")
  fechaEntregaAntecedentes    DateTime? @map("fecha_entrega_antecedentes")

  // Información financiera y contractual
  estimacion                      Int?      @map("estimacion")
  fuenteFinanciamiento            String?   @map("fuente_financiamiento") @db.NVarChar(255)
  visibilidadMonto                Int?      @map("visibilidad_monto")
  tiempo                          String?   @db.NVarChar(50)
  unidadTiempo                    String?   @map("unidad_tiempo") @db.NVarChar(10)
  modalidad                       Int?
  tipoPago                        String?   @map("tipo_pago") @db.NVarChar(10)
  nombreResponsablePago           String?   @map("nombre_responsable_pago") @db.NVarChar(255)
  emailResponsablePago            String?   @map("email_responsable_pago") @db.NVarChar(255)
  nombreResponsableContrato       String?   @map("nombre_responsable_contrato") @db.NVarChar(255)
  emailResponsableContrato        String?   @map("email_responsable_contrato") @db.NVarChar(255)
  fonoResponsableContrato         String?   @map("fono_responsable_contrato") @db.NVarChar(50)
  unidadTiempoDuracionContrato    Int?      @map("unidad_tiempo_duracion_contrato")
  tiempoDuracionContrato          String?   @map("tiempo_duracion_contrato") @db.NVarChar(50)
  tipoDuracionContrato            String?   @map("tipo_duracion_contrato") @db.NVarChar(10)

  // Condiciones y requisitos
  prohibicionContratacion         String?   @map("prohibicion_contratacion") @db.NVarChar(MAX)
  subContratacion                 String?   @map("sub_contratacion") @db.NVarChar(10)
  justificacionMontoEstimado      String?   @map("justificacion_monto_estimado") @db.NVarChar(MAX)
  observacionContract             String?   @map("observacion_contract") @db.NVarChar(MAX)
  extensionPlazo                  Int?      @map("extension_plazo")
  esBaseTipo                      Int?      @map("es_base_tipo")
  unidadTiempoContratoLicitacion  String?   @map("unidad_tiempo_contrato_licitacion") @db.NVarChar(10)
  valorTiempoRenovacion           String?   @map("valor_tiempo_renovacion") @db.NVarChar(50)
  periodoTiempoRenovacion         String?   @map("periodo_tiempo_renovacion") @db.NVarChar(10)
  esRenovable                     Int?      @map("es_renovable")
  codigoBIP                       String?   @map("codigo_bip") @db.NVarChar(100)

  // Direcciones
  direccionVisita   String? @map("direccion_visita") @db.NVarChar(500)
  direccionEntrega  String? @map("direccion_entrega") @db.NVarChar(500)

  responsable     User?                  @relation("LicitacionResponsable", fields: [responsableId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdBy       User                   @relation("LicitacionCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  deletedBy       User?                  @relation("LicitacionDeletedBy", fields: [deletedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  documentos      Documento[]
  notas           Nota[]
  items           LicitacionItem[]
  soporteTecnico  SoporteTecnico[]
  adjudicacion    Adjudicacion?

  @@map("licitaciones")
  @@index([estado], map: "idx_licitacion_estado")
  @@index([fechaCierre], map: "idx_licitacion_fecha_cierre")
  @@index([responsableId], map: "idx_licitacion_responsable")
  @@index([deletedAt], map: "idx_licitacion_deleted_at")
  @@index([folio], map: "idx_licitacion_folio")
  @@index([regionUnidad], map: "idx_licitacion_region")
  @@index([comunaUnidad], map: "idx_licitacion_comuna")
  @@index([codigoOrganismo], map: "idx_licitacion_organismo")
}

model Cita {
  id            String   @id @default(cuid()) @db.NVarChar(100)
  folio         Int      @unique @default(autoincrement())
  titulo        String   @db.NVarChar(255)
  descripcion   String?  @db.NVarChar(MAX)
  tipo          String   @default("REUNION") @db.NVarChar(50) // REUNION, PRESENTACION, VISITA, ENTREGA, OTRO
  estado        String   @default("PROGRAMADA") @db.NVarChar(50) // PROGRAMADA, CONFIRMADA, COMPLETADA, CANCELADA
  fechaInicio   DateTime @map("fecha_inicio")
  fechaFin      DateTime @map("fecha_fin")
  ubicacion     String?  @db.NVarChar(255)
  urlReunion    String?  @map("url_reunion") @db.NVarChar(500)
  licitacionId  String?  @map("licitacion_id") @db.NVarChar(100)
  organizadorId String   @map("organizador_id") @db.NVarChar(100)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organizador    User                 @relation(fields: [organizadorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  participantes  CitaParticipante[]
  documentos     Documento[]
  notas          Nota[]
  soporteTecnico SoporteTecnico[]

  @@map("citas")
  @@index([fechaInicio], map: "idx_cita_fecha_inicio")
  @@index([estado], map: "idx_cita_estado")
  @@index([organizadorId], map: "idx_cita_organizador")
  @@index([folio], map: "idx_cita_folio")
}

model CitaParticipante {
  id        String   @id @default(cuid()) @db.NVarChar(100)
  citaId    String   @map("cita_id") @db.NVarChar(100)
  userId    String   @map("user_id") @db.NVarChar(100)
  asistio   Boolean  @default(false)
  createdAt DateTime @default(now())

  cita Cita @relation(fields: [citaId], references: [id], onDelete: Cascade)
  user User @relation("CitaUser", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([citaId, userId])
  @@map("cita_participantes")
  @@index([citaId], map: "idx_cita_participante_cita")
  @@index([userId], map: "idx_cita_participante_user")
}

model Notificacion {
  id        String   @id @default(cuid()) @db.NVarChar(100)
  tipo      String   @db.NVarChar(50) // INFO, ADVERTENCIA, ERROR, EXITO
  titulo    String   @db.NVarChar(255)
  mensaje   String   @db.NVarChar(MAX)
  leida     Boolean  @default(false)
  userId    String   @map("user_id") @db.NVarChar(100)
  referenceType String? @map("reference_type") @db.NVarChar(50) // TICKET, LICITACION, CITA
  referenceId   String? @map("reference_id") @db.NVarChar(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
  @@index([userId, leida], map: "idx_notificacion_user_leida")
  @@index([createdAt], map: "idx_notificacion_fecha")
}

model Documento {
  id            String   @id @default(cuid()) @db.NVarChar(100)
  nombre        String   @db.NVarChar(255)
  descripcion   String?  @db.NVarChar(500)
  tipoArchivo   String   @map("tipo_archivo") @db.NVarChar(100)
  tamano        Int      // Tamaño en bytes
  rutaArchivo   String   @map("ruta_archivo") @db.NVarChar(500)
  licitacionId  String?  @map("licitacion_id") @db.NVarChar(100)
  citaId        String?  @map("cita_id") @db.NVarChar(100)
  ticketId      String?  @map("ticket_id") @db.NVarChar(100)
  uploadedById  String   @map("uploaded_by_id") @db.NVarChar(100)
  createdAt     DateTime @default(now())

  licitacion Licitacion? @relation(fields: [licitacionId], references: [id], onDelete: Cascade)
  cita       Cita?       @relation(fields: [citaId], references: [id], onDelete: Cascade)
  ticket     Ticket?     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploadedBy User        @relation(fields: [uploadedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("documentos")
  @@index([licitacionId], map: "idx_documento_licitacion")
  @@index([citaId], map: "idx_documento_cita")
  @@index([ticketId], map: "idx_documento_ticket")
}

model Nota {
  id           String   @id @default(cuid()) @db.NVarChar(100)
  contenido    String   @db.NVarChar(MAX)
  licitacionId String?  @map("licitacion_id") @db.NVarChar(100)
  citaId       String?  @map("cita_id") @db.NVarChar(100)
  ticketId     String?  @map("ticket_id") @db.NVarChar(100)
  autorId      String   @map("autor_id") @db.NVarChar(100)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  licitacion Licitacion? @relation(fields: [licitacionId], references: [id], onDelete: Cascade)
  cita       Cita?       @relation(fields: [citaId], references: [id], onDelete: Cascade)
  ticket     Ticket?     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  autor      User        @relation(fields: [autorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("notas")
  @@index([licitacionId], map: "idx_nota_licitacion")
  @@index([citaId], map: "idx_nota_cita")
  @@index([ticketId], map: "idx_nota_ticket")
}

model AuditoriaLog {
  id        String   @id @default(cuid()) @db.NVarChar(100)
  accion    String   @db.NVarChar(100) // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entidad   String   @db.NVarChar(100) // USER, TICKET, LICITACION, etc.
  entidadId String?  @map("entidad_id") @db.NVarChar(100)
  cambios   String?  @db.NVarChar(MAX) // JSON con los cambios
  userId    String?  @map("user_id") @db.NVarChar(100)
  ipAddress String?  @map("ip_address") @db.NVarChar(45)
  userAgent String?  @map("user_agent") @db.NVarChar(500)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("auditoria_logs")
  @@index([userId], map: "idx_auditoria_user")
  @@index([entidad, entidadId], map: "idx_auditoria_entidad")
  @@index([createdAt], map: "idx_auditoria_fecha")
}

model LicitacionItem {
  id              String      @id @default(cuid()) @db.NVarChar(100)
  licitacionId    String      @map("licitacion_id") @db.NVarChar(100)
  correlativo     Int
  codigoProducto  String?     @map("codigo_producto") @db.NVarChar(50)
  codigoCategoria String?     @map("codigo_categoria") @db.NVarChar(50)
  categoria       String?     @db.NVarChar(MAX)
  nombreProducto  String?     @map("nombre_producto") @db.NVarChar(500)
  descripcion     String?     @db.NVarChar(MAX)
  unidadMedida    String?     @map("unidad_medida") @db.NVarChar(50)
  cantidad        Decimal?    @db.Decimal(18, 2)
  createdAt       DateTime    @default(now())

  licitacion Licitacion @relation(fields: [licitacionId], references: [id], onDelete: Cascade)

  @@map("licitaciones_items")
  @@index([licitacionId], map: "idx_licitacion_item_licitacion")
  @@index([codigoProducto], map: "idx_licitacion_item_producto")
}

model Adjudicacion {
  id                    String      @id @default(cuid()) @db.NVarChar(100)
  licitacionId          String      @unique @map("licitacion_id") @db.NVarChar(100)

  // Información de la adjudicación
  numeroAdjudicacion    String?     @map("numero_adjudicacion") @db.NVarChar(50)
  tipoAdjudicacion      Int?        @map("tipo_adjudicacion")
  cantidadOferentes     Int?        @map("cantidad_oferentes")
  fechaAdjudicacion     DateTime?   @map("fecha_adjudicacion")

  // Información del proveedor ganador
  proveedorRut          String?     @map("proveedor_rut") @db.NVarChar(50)
  proveedorNombre       String?     @map("proveedor_nombre") @db.NVarChar(500)
  montoAdjudicado       Decimal?    @map("monto_adjudicado") @db.Decimal(18, 2)

  // Información adicional
  observaciones         String?     @db.NVarChar(MAX)
  estadoAdjudicacion    String?     @map("estado_adjudicacion") @db.NVarChar(50)

  // Metadata
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  licitacion Licitacion @relation(fields: [licitacionId], references: [id], onDelete: Cascade)

  @@map("adjudicaciones")
  @@index([licitacionId], map: "idx_adjudicacion_licitacion")
  @@index([proveedorRut], map: "idx_adjudicacion_proveedor")
  @@index([fechaAdjudicacion], map: "idx_adjudicacion_fecha")
}

model SoporteTecnico {
  id                    String    @id @default(cuid()) @db.NVarChar(100)
  licitacionId          String?   @map("licitacion_id") @db.NVarChar(100)
  ticketId              String?   @map("ticket_id") @db.NVarChar(100)
  citaId                String?   @map("cita_id") @db.NVarChar(100)

  // Información del contacto
  nombreContacto        String    @map("nombre_contacto") @db.NVarChar(255)
  cargoContacto         String?   @map("cargo_contacto") @db.NVarChar(255)
  emailContacto         String?   @map("email_contacto") @db.NVarChar(255)
  telefonoContacto      String?   @map("telefono_contacto") @db.NVarChar(50)
  empresaContacto       String?   @map("empresa_contacto") @db.NVarChar(255)

  // Información del soporte
  tipoSoporte           String    @map("tipo_soporte") @db.NVarChar(100) // TECNICO, COMERCIAL, ADMINISTRATIVO, LEGAL, OTRO
  descripcion           String?   @db.NVarChar(MAX)
  observaciones         String?   @db.NVarChar(MAX)
  estado                String    @default("ACTIVO") @db.NVarChar(50) // ACTIVO, INACTIVO, ARCHIVADO
  prioridad             String    @default("MEDIA") @db.NVarChar(50) // ALTA, MEDIA, BAJA

  // Información de seguimiento
  fechaContacto         DateTime? @map("fecha_contacto")
  proximoSeguimiento    DateTime? @map("proximo_seguimiento")

  // Horarios de atención
  horarioInicio         String?   @map("horario_inicio") @db.NVarChar(10)        // Formato: "09:00"
  horarioFin            String?   @map("horario_fin") @db.NVarChar(10)           // Formato: "18:00"
  diasDisponibles       String?   @map("dias_disponibles") @db.NVarChar(100)     // Ejemplo: "Lunes a Viernes"
  zonaHoraria           String?   @map("zona_horaria") @db.NVarChar(50) @default("America/Santiago")
  observacionesHorario  String?   @map("observaciones_horario") @db.NVarChar(MAX)

  // Metadata
  createdById           String    @map("created_by_id") @db.NVarChar(100)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  licitacion Licitacion? @relation(fields: [licitacionId], references: [id], onDelete: Cascade)
  ticket     Ticket?     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  cita       Cita?       @relation(fields: [citaId], references: [id], onDelete: Cascade)

  @@map("soporte_tecnico")
  @@index([licitacionId], map: "idx_soporte_licitacion")
  @@index([ticketId], map: "idx_soporte_ticket")
  @@index([citaId], map: "idx_soporte_cita")
  @@index([estado], map: "idx_soporte_estado")
  @@index([tipoSoporte], map: "idx_soporte_tipo")
}
